{% extends "base.html" %}

{% block title %}Performances - College Event Scores{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-music me-2"></i>Performance Tracker</h1>
            <div>
                <!-- <a href="/admin" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-cogs me-1"></i>Admin
                </a>
                <a href="/leaderboard" class="btn btn-outline-primary">
                    <i class="fas fa-trophy me-1"></i>Leaderboard
                </a> -->
            </div>
        </div>

        <!-- Performance Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success">
                    <div class="card-body text-center">
                        <h3 id="completedCount">
                            {% set completed = performances|selectattr("is_completed")|list|length %}
                            {{ completed }}
                        </h3>
                        <p class="mb-0">Completed</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning">
                    <div class="card-body text-center">
                        <h3 id="pendingCount">
                            {% set pending = performances|rejectattr("is_completed")|list|length %}
                            {{ pending }}
                        </h3>
                        <p class="mb-0">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info">
                    <div class="card-body text-center">
                        <h3 id="totalCount">{{ performances|length }}</h3>
                        <p class="mb-0">Total</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performances Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Performer</th>
                                <th>Performance Type</th>
                                <th>Year</th>
                                <th>Contact</th>
                                <th>Time Slot</th>
                                <th>MC Session</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for performance in performances %}
                            <tr data-performance-id="{{ performance.id }}" 
                                class="{% if performance.is_completed %}table-success{% endif %}">
                                <td>{{ performance.id }}</td>
                                <td>
                                    <strong>{{ performance.performer_name }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ performance.performance_type }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">Year {{ performance.year }}</span>
                                </td>
                                <td>
                                    {% if performance.contact_number %}
                                        <small class="text-muted">{{ performance.contact_number }}</small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if performance.time_slot %}
                                        <small>{{ performance.time_slot }}</small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if performance.mc_session %}
                                        <span class="badge bg-primary">{{ performance.mc_session }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if performance.is_completed %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Completed
                                        </span>
                                        {% if performance.completed_at %}
                                            <br><small class="text-muted">{{ performance.completed_at.strftime('%H:%M %d/%m') }}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if performance.is_completed %}
                                        <button class="btn btn-sm btn-outline-warning uncomplete-btn" 
                                                data-performance-id="{{ performance.id }}"
                                                title="Mark as not completed">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-success complete-btn" 
                                                data-performance-id="{{ performance.id }}"
                                                title="Mark as completed">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-info notes-btn" 
                                            data-performance-id="{{ performance.id }}"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#notesModal"
                                            data-notes="{{ performance.notes or '' }}"
                                            data-performer-name="{{ performance.performer_name }}"
                                            title="Add/Edit notes">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">Performance Notes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="performerName" class="mb-3"></h6>
                <textarea class="form-control" id="notesTextarea" rows="4" 
                          placeholder="Add notes about this performance..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNotesBtn">Save Notes</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading spinner -->
<div id="loadingSpinner" class="d-none position-fixed top-50 start-50 translate-middle">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    let currentPerformanceId = null;

    // Show loading spinner
    function showLoading() {
        loadingSpinner.classList.remove('d-none');
    }

    // Hide loading spinner
    function hideLoading() {
        loadingSpinner.classList.add('d-none');
    }

    // Update statistics
    function updateStats() {
        const rows = document.querySelectorAll('tbody tr');
        const completed = document.querySelectorAll('tbody tr.table-success').length;
        const total = rows.length;
        const pending = total - completed;

        document.getElementById('completedCount').textContent = completed;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('totalCount').textContent = total;
    }

    // Mark performance as completed
    document.addEventListener('click', function(e) {
        if (e.target.closest('.complete-btn')) {
            const btn = e.target.closest('.complete-btn');
            const performanceId = btn.dataset.performanceId;
            
            showLoading();
            
            fetch(`/api/performances/${performanceId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    location.reload(); // Reload to update the interface
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating performance status');
            })
            .finally(() => {
                hideLoading();
            });
        }
    });

    // Mark performance as not completed
    document.addEventListener('click', function(e) {
        if (e.target.closest('.uncomplete-btn')) {
            const btn = e.target.closest('.uncomplete-btn');
            const performanceId = btn.dataset.performanceId;
            
            showLoading();
            
            fetch(`/api/performances/${performanceId}/uncomplete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    location.reload(); // Reload to update the interface
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating performance status');
            })
            .finally(() => {
                hideLoading();
            });
        }
    });

    // Handle notes modal
    document.addEventListener('click', function(e) {
        if (e.target.closest('.notes-btn')) {
            const btn = e.target.closest('.notes-btn');
            currentPerformanceId = btn.dataset.performanceId;
            const notes = btn.dataset.notes;
            const performerName = btn.dataset.performerName;
            
            document.getElementById('performerName').textContent = performerName;
            document.getElementById('notesTextarea').value = notes;
        }
    });

    // Save notes
    document.getElementById('saveNotesBtn').addEventListener('click', function() {
        if (!currentPerformanceId) return;
        
        const notes = document.getElementById('notesTextarea').value;
        showLoading();
        
        fetch(`/api/performances/${currentPerformanceId}/notes`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes: notes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                // Update the button's data-notes attribute
                const btn = document.querySelector(`.notes-btn[data-performance-id="${currentPerformanceId}"]`);
                if (btn) {
                    btn.dataset.notes = notes;
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('notesModal'));
                modal.hide();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving notes');
        })
        .finally(() => {
            hideLoading();
        });
    });
});
</script>
{% endblock %}
